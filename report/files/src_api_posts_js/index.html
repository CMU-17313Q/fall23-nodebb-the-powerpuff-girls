<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - src/api/posts.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>src/api/posts.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">63.77</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">433</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">45.57</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">4.69</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">/* eslint-disable function-paren-newline */
/* eslint-disable no-confusing-arrow */
/* eslint-disable implicit-arrow-linebreak */
/* eslint-disable arrow-parens */
/* eslint-disable quotes */

&quot;use strict&quot;;

const validator = require(&quot;validator&quot;);
const _ = require(&quot;lodash&quot;);

const utils = require(&quot;../utils&quot;);
const user = require(&quot;../user&quot;);
const posts = require(&quot;../posts&quot;);
const topics = require(&quot;../topics&quot;);
const groups = require(&quot;../groups&quot;);
const meta = require(&quot;../meta&quot;);
const events = require(&quot;../events&quot;);
const privileges = require(&quot;../privileges&quot;);
const apiHelpers = require(&quot;./helpers&quot;);
const websockets = require(&quot;../socket.io&quot;);
const socketHelpers = require(&quot;../socket.io/helpers&quot;);

const postsAPI = module.exports;

postsAPI.get = async function (caller, data) {
    const [userPrivileges, post, voted] = await Promise.all([
        privileges.posts.get([data.pid], caller.uid),
        posts.getPostData(data.pid),
        posts.hasVoted(data.pid, caller.uid),
    ]);
    if (!post) {
        return null;
    }
    Object.assign(post, voted);

    const userPrivilege = userPrivileges[0];
    if (!userPrivilege.read || !userPrivilege[&quot;topics:read&quot;]) {
        return null;
    }

    post.ip = userPrivilege.isAdminOrMod ? post.ip : undefined;
    const selfPost = caller.uid &amp;&amp; caller.uid === parseInt(post.uid, 10);
    if (post.deleted &amp;&amp; !(userPrivilege.isAdminOrMod || selfPost)) {
        post.content = &quot;[[topic:post_is_deleted]]&quot;;
    }

    return post;
};

postsAPI.edit = async function (caller, data) {
    if (
        !data ||
        !data.pid ||
        (meta.config.minimumPostLength !== 0 &amp;&amp; !data.content)
    ) {
        throw new Error(&quot;[[error:invalid-data]]&quot;);
    }
    if (!caller.uid) {
        throw new Error(&quot;[[error:not-logged-in]]&quot;);
    }
    // Trim and remove HTML (latter for composers that send in HTML, like redactor)
    const contentLen = utils.stripHTMLTags(data.content).trim().length;

    if (data.title &amp;&amp; data.title.length &lt; meta.config.minimumTitleLength) {
        throw new Error(
            `[[error:title-too-short, ${meta.config.minimumTitleLength}]]`
        );
    } else if (
        data.title &amp;&amp;
        data.title.length &gt; meta.config.maximumTitleLength
    ) {
        throw new Error(
            `[[error:title-too-long, ${meta.config.maximumTitleLength}]]`
        );
    } else if (
        meta.config.minimumPostLength !== 0 &amp;&amp;
        contentLen &lt; meta.config.minimumPostLength
    ) {
        throw new Error(
            `[[error:content-too-short, ${meta.config.minimumPostLength}]]`
        );
    } else if (contentLen &gt; meta.config.maximumPostLength) {
        throw new Error(
            `[[error:content-too-long, ${meta.config.maximumPostLength}]]`
        );
    }

    data.uid = caller.uid;
    data.req = apiHelpers.buildReqObject(caller);
    data.timestamp = parseInt(data.timestamp, 10) || Date.now();

    const editResult = await posts.edit(data);
    if (editResult.topic.isMainPost) {
        await topics.thumbs.migrate(data.uuid, editResult.topic.tid);
    }
    const selfPost =
        parseInt(caller.uid, 10) === parseInt(editResult.post.uid, 10);
    if (!selfPost &amp;&amp; editResult.post.changed) {
        await events.log({
            type: `post-edit`,
            uid: caller.uid,
            ip: caller.ip,
            pid: editResult.post.pid,
            oldContent: editResult.post.oldContent,
            newContent: editResult.post.newContent,
        });
    }

    if (editResult.topic.renamed) {
        await events.log({
            type: &quot;topic-rename&quot;,
            uid: caller.uid,
            ip: caller.ip,
            tid: editResult.topic.tid,
            oldTitle: validator.escape(String(editResult.topic.oldTitle)),
            newTitle: validator.escape(String(editResult.topic.title)),
        });
    }
    const postObj = await posts.getPostSummaryByPids(
        [editResult.post.pid],
        caller.uid,
        {}
    );
    const returnData = { ...postObj[0], ...editResult.post };
    returnData.topic = { ...postObj[0].topic, ...editResult.post.topic };

    if (!editResult.post.deleted) {
        websockets
            .in(`topic_${editResult.topic.tid}`)
            .emit(&quot;event:post_edited&quot;, editResult);
        return returnData;
    }

    const memberData = await groups.getMembersOfGroups([
        &quot;administrators&quot;,
        &quot;Global Moderators&quot;,
        `cid:${editResult.topic.cid}:privileges:moderate`,
        `cid:${editResult.topic.cid}:privileges:groups:moderate`,
    ]);

    const uids = _.uniq(_.flatten(memberData).concat(String(caller.uid)));
    uids.forEach((uid) =&gt;
        websockets.in(`uid_${uid}`).emit(&quot;event:post_edited&quot;, editResult)
    );
    return returnData;
};

postsAPI.delete = async function (caller, data) {
    await deleteOrRestore(caller, data, {
        command: &quot;delete&quot;,
        event: &quot;event:post_deleted&quot;,
        type: &quot;post-delete&quot;,
    });
};

postsAPI.restore = async function (caller, data) {
    await deleteOrRestore(caller, data, {
        command: &quot;restore&quot;,
        event: &quot;event:post_restored&quot;,
        type: &quot;post-restore&quot;,
    });
};

async function deleteOrRestore(caller, data, params) {
    if (!data || !data.pid) {
        throw new Error(&quot;[[error:invalid-data]]&quot;);
    }
    const postData = await posts.tools[params.command](caller.uid, data.pid);
    const results = await isMainAndLastPost(data.pid);
    if (results.isMain &amp;&amp; results.isLast) {
        await deleteOrRestoreTopicOf(params.command, data.pid, caller);
    }

    websockets.in(`topic_${postData.tid}`).emit(params.event, postData);

    await events.log({
        type: params.type,
        uid: caller.uid,
        pid: data.pid,
        tid: postData.tid,
        ip: caller.ip,
    });
}

async function deleteOrRestoreTopicOf(command, pid, caller) {
    const topic = await posts.getTopicFields(pid, [
        &quot;tid&quot;,
        &quot;cid&quot;,
        &quot;deleted&quot;,
        &quot;scheduled&quot;,
    ]);
    // exempt scheduled topics from being deleted/restored
    if (topic.scheduled) {
        return;
    }
    // command: delete/restore
    await apiHelpers.doTopicAction(
        command,
        topic.deleted ? &quot;event:topic_restored&quot; : &quot;event:topic_deleted&quot;,
        caller,
        { tids: [topic.tid], cid: topic.cid }
    );
}

postsAPI.purge = async function (caller, data) {
    if (!data || !parseInt(data.pid, 10)) {
        throw new Error(&quot;[[error:invalid-data]]&quot;);
    }

    const results = await isMainAndLastPost(data.pid);
    if (results.isMain &amp;&amp; !results.isLast) {
        throw new Error(&quot;[[error:cant-purge-main-post]]&quot;);
    }

    const isMainAndLast = results.isMain &amp;&amp; results.isLast;
    const postData = await posts.getPostFields(data.pid, [&quot;toPid&quot;, &quot;tid&quot;]);
    postData.pid = data.pid;

    const canPurge = await privileges.posts.canPurge(data.pid, caller.uid);
    if (!canPurge) {
        throw new Error(&quot;[[error:no-privileges]]&quot;);
    }
    require(&quot;../posts/cache&quot;).del(data.pid);
    await posts.purge(data.pid, caller.uid);

    websockets.in(`topic_${postData.tid}`).emit(&quot;event:post_purged&quot;, postData);
    const topicData = await topics.getTopicFields(postData.tid, [
        &quot;title&quot;,
        &quot;cid&quot;,
    ]);

    await events.log({
        type: &quot;post-purge&quot;,
        pid: data.pid,
        uid: caller.uid,
        ip: caller.ip,
        tid: postData.tid,
        title: String(topicData.title),
    });

    if (isMainAndLast) {
        await apiHelpers.doTopicAction(&quot;purge&quot;, &quot;event:topic_purged&quot;, caller, {
            tids: [postData.tid],
            cid: topicData.cid,
        });
    }
};

async function isMainAndLastPost(pid) {
    const [isMain, topicData] = await Promise.all([
        posts.isMain(pid),
        posts.getTopicFields(pid, [&quot;postcount&quot;]),
    ]);
    return {
        isMain: isMain,
        isLast: topicData &amp;&amp; topicData.postcount === 1,
    };
}

postsAPI.move = async function (caller, data) {
    if (!caller.uid) {
        throw new Error(&quot;[[error:not-logged-in]]&quot;);
    }
    if (!data || !data.pid || !data.tid) {
        throw new Error(&quot;[[error:invalid-data]]&quot;);
    }
    const canMove = await Promise.all([
        privileges.topics.isAdminOrMod(data.tid, caller.uid),
        privileges.posts.canMove(data.pid, caller.uid),
    ]);
    if (!canMove.every(Boolean)) {
        throw new Error(&quot;[[error:no-privileges]]&quot;);
    }

    await topics.movePostToTopic(caller.uid, data.pid, data.tid);

    const [postDeleted, topicDeleted] = await Promise.all([
        posts.getPostField(data.pid, &quot;deleted&quot;),
        topics.getTopicField(data.tid, &quot;deleted&quot;),
        await events.log({
            type: `post-move`,
            uid: caller.uid,
            ip: caller.ip,
            pid: data.pid,
            toTid: data.tid,
        }),
    ]);

    if (!postDeleted &amp;&amp; !topicDeleted) {
        socketHelpers.sendNotificationToPostOwner(
            data.pid,
            caller.uid,
            &quot;move&quot;,
            &quot;notifications:moved_your_post&quot;
        );
    }
};

postsAPI.upvote = async function (caller, data) {
    return await apiHelpers.postCommand(
        caller,
        &quot;upvote&quot;,
        &quot;voted&quot;,
        &quot;notifications:upvoted_your_post_in&quot;,
        data
    );
};

postsAPI.downvote = async function (caller, data) {
    return await apiHelpers.postCommand(caller, &quot;downvote&quot;, &quot;voted&quot;, &quot;&quot;, data);
};

postsAPI.unvote = async function (caller, data) {
    return await apiHelpers.postCommand(caller, &quot;unvote&quot;, &quot;voted&quot;, &quot;&quot;, data);
};

postsAPI.bookmark = async function (caller, data) {
    return await apiHelpers.postCommand(
        caller,
        &quot;bookmark&quot;,
        &quot;bookmarked&quot;,
        &quot;&quot;,
        data
    );
};

postsAPI.unbookmark = async function (caller, data) {
    return await apiHelpers.postCommand(
        caller,
        &quot;unbookmark&quot;,
        &quot;bookmarked&quot;,
        &quot;&quot;,
        data
    );
};

postsAPI.endorse = async function (caller, data) {
    return await apiHelpers.postCommand(
        caller,
        &quot;endorse&quot;,
        &quot;endorsed&quot;,
        &quot;&quot;,
        data
    );
};

postsAPI.unendorse = async function (caller, data) {
    return await apiHelpers.postCommand(
        caller,
        &quot;unendorse&quot;,
        &quot;endorsed&quot;,
        &quot;&quot;,
        data
    );
};

async function diffsPrivilegeCheck(pid, uid) {
    const [deleted, privilegesData] = await Promise.all([
        posts.getPostField(pid, &quot;deleted&quot;),
        privileges.posts.get([pid], uid),
    ]);

    const allowed =
        privilegesData[0][&quot;posts:history&quot;] &amp;&amp;
        (deleted ? privilegesData[0][&quot;posts:view_deleted&quot;] : true);
    if (!allowed) {
        throw new Error(&quot;[[error:no-privileges]]&quot;);
    }
}

postsAPI.getDiffs = async (caller, data) =&gt; {
    await diffsPrivilegeCheck(data.pid, caller.uid);
    const timestamps = await posts.diffs.list(data.pid);
    const post = await posts.getPostFields(data.pid, [&quot;timestamp&quot;, &quot;uid&quot;]);

    const diffs = await posts.diffs.get(data.pid);
    const uids = diffs.map((diff) =&gt; diff.uid || null);
    uids.push(post.uid);
    let usernames = await user.getUsersFields(uids, [&quot;username&quot;]);
    usernames = usernames.map((userObj) =&gt;
        userObj.uid ? userObj.username : null
    );

    const cid = await posts.getCidByPid(data.pid);
    const [isAdmin, isModerator] = await Promise.all([
        user.isAdministrator(caller.uid),
        privileges.users.isModerator(caller.uid, cid),
    ]);

    // timestamps returned by posts.diffs.list are strings
    timestamps.push(String(post.timestamp));

    return {
        timestamps: timestamps,
        revisions: timestamps.map((timestamp, idx) =&gt; ({
            timestamp: timestamp,
            username: usernames[idx],
        })),
        // Only admins, global mods and moderator of that cid can delete a diff
        deletable: isAdmin || isModerator,
        // These and post owners can restore to a different post version
        editable:
            isAdmin ||
            isModerator ||
            parseInt(caller.uid, 10) === parseInt(post.uid, 10),
    };
};

postsAPI.loadDiff = async (caller, data) =&gt; {
    await diffsPrivilegeCheck(data.pid, caller.uid);
    return await posts.diffs.load(data.pid, data.since, caller.uid);
};

postsAPI.restoreDiff = async (caller, data) =&gt; {
    const cid = await posts.getCidByPid(data.pid);
    const canEdit = await privileges.categories.can(
        &quot;posts:edit&quot;,
        cid,
        caller.uid
    );
    if (!canEdit) {
        throw new Error(&quot;[[error:no-privileges]]&quot;);
    }

    const edit = await posts.diffs.restore(
        data.pid,
        data.since,
        caller.uid,
        apiHelpers.buildReqObject(caller)
    );
    websockets.in(`topic_${edit.topic.tid}`).emit(&quot;event:post_edited&quot;, edit);
};</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ cyclomatic }} <br>
    Length : {{ halstead.length }} <br>
    Difficulty : {{ halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
